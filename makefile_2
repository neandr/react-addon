	#  gWahl  2016-11-07

MAKE_XPI:='vContacts.xpi'

	#  Building a XPI for Thunderbird vContacts - Addressbook)
	#  See at https://github.com/neandr/vContacts/releases for
	#  current XPI version

XPI_LOCATION:='/media/guenter/DATA/_Mozilla/TB_gW/Profiles/201603.GW/extensions/tbvcontacts@gneandr.de.xpi'

#   Build XPI_NAME with date+time stamping with 
#     -- full directory name  --> stores XPI to parent directory
NAME:=$(CURDIR)
#     -- name of file only    --> stores XPI to current directory
# NAME:=$(notdir $(CURDIR))

XPI_NAME:=$(NAME)$(shell date +'_%Y-%m-%d_%H%M').xpi

XPI_SRC:=$(shell find content -type f) $(shell find modules -type f) $(shell find defaults -type f) $(shell find react -type f)
#   alternatively
# XPI_SRC:=$(wildcard content/*) $(wildcard modules/*) $(wildcard defaults/*) $(wildcard react/*.jsx)

SRC = $(wildcard react/*.jsx)
LIB = $(SRC:react/%.jsx=modules/react/%.js)

modules/react:
	mkdir -p $@

modules/react/%.js: react/%.jsx
ifeq (, $(shell which node ))
	nodejs node_modules/.bin/babel $< -o $@ --presets react
else
	node node_modules/.bin/babel $< -o $@ --presets react
endif


react: npm modules/react $(LIB)
	#  @echo $(XPI_NAME) > stamp.log
	@echo $(notdir $(CURDIR))$(shell date +'_%Y-%m-%d_%H%M') > stamp.log


xpi: $(XPI_NAME)
	#
	#  Copy the xpi to current directory  -->  $(MAKE_XPI)
	#  To make $(MAKE_XPI) public upload to Github Releases,
	#  e.g  https://github.com/neandr/vContacts/releases
	#
	#
	$(shell cp $(XPI_NAME) $(MAKE_XPI))
	$(shell cp $(XPI_NAME) $(XPI_LOCATION))
	#  ___ XPI ___ generated:   $(XPI_NAME)



$(XPI_NAME): $(XPI_SRC) $(LIB) chrome.manifest install.rdf package.json stamp.log makefile makefile_2 LICENSE README.md
	#
	#  Build XPI and include div files
	#
	zip -r $@ $^


npm: package.json
	#
	#  Make sure npm is installed
	#
	npm install

clean: 
	#
	#  clean LIB and XPI
	#
	rm -f $(LIB)
	rm -f $(XPI_NAME)

rebuild: clean npm react xpi
